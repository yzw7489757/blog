<!DOCTYPE html>
<html lang="zh-Hans">
  <head><meta name="generator" content="Hexo 3.9.0"><link rel="manifest" href="/manifest.json"><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

<meta name="theme-color" content="#f8f5ec">
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="YuanZiWen"><meta name="keywords" content="Seven YuanZiWen"><link rel="alternate" href="/atom.xml" title="Seven Blog"><link rel="shortcut icon" type="image/x-icon" href="https://static.yuanziwen.cn/blog/favicon.ico?v=2.11.0">
<link rel="canonical" href="blog.yuanziwen.cn/page/2/">

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css">
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0">

<script id="baidu_analytics">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?1e4ffaffd9b2bc832b39e2b866a92c7b";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script><script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":"","latex":false};
</script>

    <title>Seven Blog</title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Seven Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">Home
          </li>
      </a><a href="/archives/">
        <li class="mobile-menu-item">Record
          </li>
      </a><a href="/music/">
        <li class="mobile-menu-item">Music(NoAuto)
          </li>
      </a><a href="/photo/">
        <li class="mobile-menu-item">Album
          </li>
      </a><a href="/book/">
        <li class="mobile-menu-item">Book
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Seven Blog</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            Home
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            Record
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/music/">
            Music(NoAuto)
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/photo/">
            Album
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/book/">
            Book
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><section id="posts" class="posts"><article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2019/04/14/译-从-0-创建自定义元素/">[译] 从 0 创建自定义元素</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-04-14
        </span></div>
    </header>

    <div class="post-content"><blockquote>
<ul>
<li>原文地址：<a href="https://css-tricks.com/creating-a-custom-element-from-scratch/" target="_blank" rel="noopener">Creating a Custom Element from Scratch</a></li>
<li>原文作者：<a href="https://css-tricks.com/author/calebdwilliams/" target="_blank" rel="noopener">Caleb Williams</a></li>
<li>译文出自：<a href="https://github.com/xitu/gold-miner" target="_blank" rel="noopener">掘金翻译计划</a></li>
<li>本文永久链接：<a href="https://github.com/xitu/gold-miner/blob/master/TODO1/creating-a-custom-element-from-scratch.md" target="_blank" rel="noopener">https://github.com/xitu/gold-miner/blob/master/TODO1/creating-a-custom-element-from-scratch.md</a></li>
<li>译者：<a href="https://github.com/yzw7489757" target="_blank" rel="noopener">Seven</a></li>
<li>校对者：<a href="https://github.com/portandbridge" target="_blank" rel="noopener">portandbridge</a>, <a href="https://github.com/wznonstop" target="_blank" rel="noopener">wznonstop</a></li>
</ul>
</blockquote>
<p>在<a href="https://github.com/xitu/gold-miner/blob/master/TODO1/crafting-reusable-html-templates.md" target="_blank" rel="noopener">上一篇文章</a>，我们在文档中创建了 HTML 模板，希望它们在需要时才呈现，这让我们开始接触 Web 组件。</p>
          <div class="read-more">
            <a href="/2019/04/14/译-从-0-创建自定义元素/" class="read-more-link">Read more..</a>
          </div>
        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2019/04/01/彻底刨析-Redux-源码/">彻底刨析 Redux 源码</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-04-01
        </span></div>
    </header>

    <div class="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>很多人总觉得 <code>Redux</code> 对于 <code>React</code> 来说就像是 <code>VueX</code> 和 <code>Vue</code> 一样的关系。</p>
<p>但其实，<code>Redux</code> 和 <code>React</code> 没有关系。只是作者和这两者有关系。</p>
<p><img src="https://static.yuanziwen.cn/blog/reduxCode/redux.png_plain" alt="alt"></p>
<p>Redux是函数式编程较为典型的例子，源码简洁明了。有助于了解设计与思想，后期从根源上找问题、复现问题也有帮助。</p>
          <div class="read-more">
            <a href="/2019/04/01/彻底刨析-Redux-源码/" class="read-more-link">Read more..</a>
          </div>
        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2019/03/13/d3数据可视化/">d3数据可视化(2)——折线图篇</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-03-13
        </span></div>
    </header>

    <div class="post-content"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.2.1/css/hint.min.css"><a id="more"></a>
<p>心血来潮，闲暇之余钻研了一些可视化的东西。记下笔记。</p>
<h2 id="d3-基础"><a href="#d3-基础" class="headerlink" title="d3 基础"></a>d3 基础</h2><p>d3 基于数据驱动，所有操作可进行链式调用，由于版本问题和官网 API 不完全符合，故本次使用 NPM<code>d3@5.7.0</code>版本</p>
<!-- more -->
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm i d3@5.7.0 --save-dev  //指定版本</span><br><span class="line">npm i d3@4.x --save-dev // 指定主要稳定版本 自动安装官方承认的4.?.?稳定版本</span><br></pre></td></tr></table></figure>

<blockquote>
<p>PS：V3 到 V4 是一个质的飞跃，当然 API 也是就像 python3 一样…不过 V4 到 V5 改动不大<br><a href="https://github.com/tianxuzhang/d3.v4-API-Translation#joining-data" target="_blank" rel="noopener">第三方翻译结果</a>，API V4 版本。<br>如果需要认识下 d3 的基础知识，可以选择性查看，也可以查看例子之后再<a href>回来熟悉一下</a></p>
</blockquote>
<h3 id="选择器"><a href="#选择器" class="headerlink" title="选择器"></a>选择器</h3><p><code>d3.select(selector)</code>和<code>d3.select(node)</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">d3.select(<span class="string">"#app"</span>); <span class="comment">//如果找到多个的话只会返回第一个</span></span><br><span class="line">d3.select(<span class="string">".app"</span>); <span class="comment">//如果找到多个的话只会返回第一个</span></span><br><span class="line">d3.select(<span class="string">"div"</span>); <span class="comment">//如果找到多个的话只会返回第一个</span></span><br></pre></td></tr></table></figure>

<p>重要的话重复三遍…</p>
<p><code>d3.selectAll(selector)</code>和<code>d3.selectAll(node)</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">d3.selectAll(<span class="string">"p"</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>selector 可以是标签名或者是 id、class<br>node 只能是选择好的节点比如 d3.select(this),不会遍历 DOM 树<br>例如</p>
</blockquote>
<h3 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h3><p>设置属性<code>selection.attr(name[, value])</code><br>例如</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">d3.selectAll(<span class="string">"p"</span>).attr(<span class="string">"color"</span>, <span class="string">"red"</span>);</span><br></pre></td></tr></table></figure>

<p>设置 class<code>selection.classed(name[, value])</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">election.classed(&#123; <span class="attr">foo</span>: <span class="literal">true</span>, <span class="attr">bar</span>: <span class="literal">false</span> &#125;);</span><br></pre></td></tr></table></figure>

<p>取得或设置样式属性<code>selection.style()</code><br>例如</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">selection.style(&#123; <span class="attr">stroke</span>: <span class="string">"black"</span>, <span class="string">"stroke-width"</span>: <span class="number">2</span> &#125;);</span><br></pre></td></tr></table></figure>

<p>取得或设置文本<code>selection.text()</code><br>例如</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">selection.text(<span class="string">"文字内容"</span>);</span><br></pre></td></tr></table></figure>

<p>取得或设置 innerHTML<code>selection.html()</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">selection.html(); <span class="comment">//获取</span></span><br><span class="line">selection.html(<span class="string">"&lt;h1&gt;标题1&lt;/h1&gt;"</span>);</span><br></pre></td></tr></table></figure>

<p>取得或设置行内属性</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">selection.property();</span><br><span class="line"><span class="comment">// 例如</span></span><br><span class="line">selection.property(&#123; <span class="attr">checked</span>: <span class="literal">true</span>, <span class="attr">disabled</span>: <span class="literal">false</span> &#125;);</span><br></pre></td></tr></table></figure>

<p>添加元素<code>selection.append(name)</code><br>例如</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">selection.append(<span class="string">"p"</span>);</span><br></pre></td></tr></table></figure>

<p>需要注意的是当<code>append</code>之后，当前的<code>this</code>会自动指向<code>append</code>的这个对象。<br>所有选择的元素集合单个属性都可以使用遍历<code>function(d,i){ return d||i}</code>的方式去写</p>
<h3 id="数据绑定"><a href="#数据绑定" class="headerlink" title="数据绑定"></a>数据绑定</h3><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">selection.datum(); <span class="comment">//取得或者绑定单个数据</span></span><br><span class="line">selection.data(); <span class="comment">//取得或者绑定设置多个数据</span></span><br><span class="line"><span class="keyword">var</span> list = [<span class="string">"banana"</span>, <span class="string">"orange"</span>, <span class="string">"apple"</span>];</span><br><span class="line"><span class="keyword">var</span> p = body.selectAll(<span class="string">"p"</span>);</span><br><span class="line">p.data(list).text(<span class="function"><span class="keyword">function</span>(<span class="params">d, i</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// d为数据，i为下标</span></span><br><span class="line">  <span class="keyword">return</span> d;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在这可能有一点要注意，上面数组是 3 个数组，但是万一 body 里的 p 标签只有一个呢，这就要用到<code>enter()</code>了</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> list = [<span class="string">"banana"</span>, <span class="string">"orange"</span>, <span class="string">"apple"</span>];</span><br><span class="line"><span class="keyword">var</span> p = body.selectAll(<span class="string">"p"</span>);</span><br><span class="line"><span class="keyword">var</span> update = p.data(list); <span class="comment">//绑定值，获取updata部分</span></span><br><span class="line"><span class="keyword">var</span> enter = update.enter(); <span class="comment">// 选定enter部分 -- 我称呼它为补集</span></span><br><span class="line">update.text(<span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"updata"</span> + d; <span class="comment">// 更新之前的值</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">enter</span><br><span class="line">  .append(<span class="string">"p"</span>) <span class="comment">//将p标签 '补' 进去</span></span><br><span class="line">  .text(<span class="function"><span class="keyword">function</span>(<span class="params">d, i</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> d;</span><br><span class="line">  &#125;);</span><br><span class="line"><span class="comment">// 补集可以添加元素，也可以直接更新其他值</span></span><br><span class="line">enter.text(<span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"enter"</span> + d; <span class="comment">// exit的没有绑定至</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>enter 通常的使用方法是<code>append()</code>添加元素</p>
<p>假如数据有 1 个，p 标签有 2 个，我们需要<code>exit()</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/13/16be8fcf176d2dca?w=591&h=326&f=png&s=8873" alt="alt"></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> list = [<span class="string">"banana"</span>];</span><br><span class="line"><span class="keyword">var</span> p = body.selectAll(<span class="string">"p"</span>);</span><br><span class="line"><span class="keyword">var</span> update = p.data(list); <span class="comment">// 绑定值，获取updata部分</span></span><br><span class="line"><span class="keyword">var</span> exit = update.exit(); <span class="comment">// 选定exit部分 -- 我称呼它为删集</span></span><br><span class="line"></span><br><span class="line">update.text(<span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"updata"</span> + d;</span><br><span class="line">&#125;);</span><br><span class="line">exit.text(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"exit"</span>; <span class="comment">// exit的没有绑定值</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>exit 通常的使用方法是<code>remove()</code>删除掉元素</p>
<p>可以为选择集的元素遍历调用函数<code>selection.each(fn)</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">selection.each(<span class="function"><span class="keyword">function</span>(<span class="params">d, i</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(d.text()); <span class="comment">// 也可以使用this打印出节点</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="刻度尺"><a href="#刻度尺" class="headerlink" title="刻度尺"></a>刻度尺</h3><p>还有刻度尺，继续……在这之前，我们需要了解 2 个概念<br><code>domain</code>是定义域，就是坐标系下的值<br><code>range</code>是值域，就是映射到 svg 画布上的值<br>domian([1,10]).range([0,100])的意思就是在画布上使用 100px 的空间去映射 1-10 的值，range 内的值会自动映射为实际宽度，当然你也可以倒序，比如 range([100,0])<br>可以理解成，<code>domian()</code>是输入域，<code>range()</code>是输出域。相当于把<code>domian</code>中的数据集映射到<code>range</code>的数据集中。</p>
<h4 id="线性比例尺-d3-scaleLinear"><a href="#线性比例尺-d3-scaleLinear" class="headerlink" title="线性比例尺 d3.scaleLinear()"></a>线性比例尺 d3.scaleLinear()</h4><p><code>domain</code>：连续型<br><code>range</code>：连续型</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> scale = d3</span><br><span class="line">  .scaleLinear()</span><br><span class="line">  .domain([<span class="number">0</span>, <span class="number">5</span>])</span><br><span class="line">  .range([<span class="number">0</span>, <span class="number">100</span>]);</span><br></pre></td></tr></table></figure>

<p>意思是创建一个线性比例尺，值为 0-5,占据的位置是 0-100 像素<br><img src="https://user-gold-cdn.xitu.io/2019/7/13/16be8fcf17775143?w=430&h=218&f=png&s=29123" alt="alt"></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">scale(<span class="number">0</span>); <span class="comment">// 0</span></span><br><span class="line">scale(<span class="number">1</span>); <span class="comment">// 20</span></span><br><span class="line">scale(<span class="number">5</span>); <span class="comment">// 100</span></span><br><span class="line"><span class="comment">// 低于范围值则也可以计算</span></span><br><span class="line">scale(<span class="number">-1</span>); <span class="comment">// -20</span></span><br></pre></td></tr></table></figure>

<p>线性比例尺超出定义域的部分会按映射拓展，这个比较适合数字类型的展示。</p>
<p>那对一些需要处理的数据怎么办呢？ 再看一个例子</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"linear"</span> <span class="attr">class</span>=<span class="string">"clear"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>n<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"linear-capped"</span> <span class="attr">class</span>=<span class="string">"clear"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>1 <span class="symbol">&amp;lt;</span>= a*n + b <span class="symbol">&amp;lt;</span>= 20<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"pow"</span> <span class="attr">class</span>=<span class="string">"clear"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>n^2<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"pow-capped"</span> <span class="attr">class</span>=<span class="string">"clear"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>1 <span class="symbol">&amp;lt;</span>= a*n^2 + b <span class="symbol">&amp;lt;</span>= 10<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"log"</span> <span class="attr">class</span>=<span class="string">"clear"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>log(n)<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"log-capped"</span> <span class="attr">class</span>=<span class="string">"clear"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>1 <span class="symbol">&amp;lt;</span>= a*log(n) + b <span class="symbol">&amp;lt;</span>= 10<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> max = <span class="number">11</span>,</span><br><span class="line">  data = [];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt; max; i++) data.push(i);</span><br><span class="line"><span class="keyword">var</span> linear = d3 <span class="comment">// 图标第一行</span></span><br><span class="line">  .scaleLinear() <span class="comment">// 创建恒等线性尺度</span></span><br><span class="line">  .domain([<span class="number">1</span>, <span class="number">10</span>])</span><br><span class="line">  .range([<span class="number">1</span>, <span class="number">10</span>]); <span class="comment">// 输出域和输入域相等，所以能够一一对应</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> linearCapped = d3</span><br><span class="line">  .scaleLinear()</span><br><span class="line">  .domain([<span class="number">1</span>, <span class="number">10</span>])</span><br><span class="line">  .range([<span class="number">1</span>, <span class="number">20</span>]); <span class="comment">// 输入域和输出域不等，函数方程式为1&lt;= a * n + b &lt;=20 ，不取整</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> pow = d3.scalePow().exponent(<span class="number">2</span>); <span class="comment">// 幂级尺度 f(n) = n^2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> powCapped = d3 <span class="comment">// 图标第一行</span></span><br><span class="line">  .scalePow()</span><br><span class="line">  .exponent(<span class="number">2</span>)</span><br><span class="line">  .domain([<span class="number">1</span>, <span class="number">10</span>]) <span class="comment">// 设置输入域</span></span><br><span class="line">  .rangeRound([<span class="number">1</span>, <span class="number">10</span>]);</span><br><span class="line"><span class="comment">// 与range()不同，rangeRound会将输出值进行向上取整 比如3^2 = 9 但是输出域是10 所以会变成类似于0.9 向上取整为2（不存在0，1为起步），如果是5^2 = 25 则显示为3</span></span><br><span class="line"><span class="comment">// 函数为1 &lt;= a*n^2 + b &lt;= 10</span></span><br><span class="line"><span class="comment">// 图标第一行</span></span><br><span class="line"><span class="keyword">var</span> log = d3.scaleLog(); <span class="comment">// 对数 log(n)</span></span><br><span class="line"><span class="comment">// 图标第六行</span></span><br><span class="line"><span class="keyword">var</span> logCapped = d3</span><br><span class="line">  .scaleLog()</span><br><span class="line">  .domain([<span class="number">1</span>, <span class="number">10</span>]) <span class="comment">// 限制输出域1&lt;= a*log(n)+b &lt;=10</span></span><br><span class="line">  .rangeRound([<span class="number">1</span>, <span class="number">10</span>]);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">data, scale, selector</span>) </span>&#123;</span><br><span class="line">  d3.select(selector)</span><br><span class="line">    .selectAll(<span class="string">"div"</span>)</span><br><span class="line">    .data(data)</span><br><span class="line">    .enter()</span><br><span class="line">    .append(<span class="string">"div"</span>)</span><br><span class="line">    .classed(<span class="string">"cell"</span>, <span class="literal">true</span>)</span><br><span class="line">    .style(<span class="string">"display"</span>, <span class="string">"inline-block"</span>)</span><br><span class="line">    .text(<span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> d3.format(<span class="string">".2"</span>)(scale(d), <span class="number">2</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">render(data, linear, <span class="string">"#linear"</span>);</span><br><span class="line">render(data, linearCapped, <span class="string">"#linear-capped"</span>);</span><br><span class="line">render(data, pow, <span class="string">"#pow"</span>);</span><br><span class="line">render(data, powCapped, <span class="string">"#pow-capped"</span>);</span><br><span class="line">render(data, log, <span class="string">"#log"</span>);</span><br><span class="line">render(data, logCapped, <span class="string">"#log-capped"</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/13/16be8fcf18414382?w=917&h=324&f=png&s=39699" alt="alt"></p>
<p>但是遇到<code>[&#39;red&#39;,&#39;green&#39;]</code>这样的数据，无法进行类型比较怎么办。<br>那就要用<code>d3.scaleBand()</code></p>
<h4 id="d3-scaleBand-序数比例尺"><a href="#d3-scaleBand-序数比例尺" class="headerlink" title="d3.scaleBand() 序数比例尺"></a>d3.scaleBand() 序数比例尺</h4><p><code>domain</code>: 离散型 比如<code>[1,2,3,4] [&#39;orange&#39;,&#39;apple&#39;,&#39;bananan&#39;]</code><br><code>range</code>: 连续型 比如<code>[0,100]</code></p>
<p><code>d3.scaleBand()</code>并不是一个连续性的比例尺，<code>domain()</code>中使用一个数组，不过<code>range()</code>需要是一个连续域。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> scale = d3</span><br><span class="line">  .scaleBand()</span><br><span class="line">  .domain([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br><span class="line">  .range([<span class="number">0</span>, <span class="number">100</span>]);</span><br></pre></td></tr></table></figure>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/13/16be8fcf18f8374d?w=433&h=220&f=png&s=11682" alt="alt"><br>可以理解成把 100 像素平均分割成四份</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">scale(<span class="number">1</span>); <span class="comment">// 0</span></span><br><span class="line">scale(<span class="number">4</span>); <span class="comment">// 75</span></span><br><span class="line"><span class="comment">// 当值不是domain的数据集，没有对应值</span></span><br><span class="line">scale(<span class="number">0</span>); <span class="comment">// 输出:undefined</span></span><br><span class="line">scale(<span class="number">5</span>); <span class="comment">// 输出:undefined</span></span><br></pre></td></tr></table></figure>

<p>不要以<code>100/4=25</code>来计算<code>scale(4)=100</code>，它计算的是起点而不是终点。</p>
<h4 id="d3-scaleOrdinal-序数比例尺"><a href="#d3-scaleOrdinal-序数比例尺" class="headerlink" title="d3.scaleOrdinal() 序数比例尺"></a>d3.scaleOrdinal() 序数比例尺</h4><p>输入域和输出域都使用离散的数据。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> scale = d3</span><br><span class="line">  .scaleOrdinal()</span><br><span class="line">  .domain([<span class="string">"2018-08-01"</span>, <span class="string">"2018-09-01"</span>, <span class="string">"2018-10-01"</span>])</span><br><span class="line">  .range([<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>]);</span><br></pre></td></tr></table></figure>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/13/16be8fcf19102482?w=602&h=374&f=png&s=27972" alt="alt"></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">scale(<span class="string">"2018-08-01"</span>); <span class="comment">// 10 true</span></span><br><span class="line">scale(<span class="string">"2018-09-01"</span>); <span class="comment">// 20 true</span></span><br><span class="line">scale(<span class="string">"2018-10-01"</span>); <span class="comment">// 30 true</span></span><br><span class="line"><span class="comment">// 当不是domain内的数据时，也能得到数据，但是不确定数据的正确性，会按照顺序再去循环取出其中的数据</span></span><br><span class="line">scale(<span class="string">"2018-11-01"</span>); <span class="comment">// 10 false</span></span><br><span class="line">scale(<span class="string">"2018-12-01"</span>); <span class="comment">// 20 false</span></span><br></pre></td></tr></table></figure>

<p>如果数据是<code>true1 true2 true3 false1 true2 false2</code> 即使读取<code>false1</code>的时候返回了<code>10</code>，<code>true2</code>是正确值，<code>false2</code>还是会延续<code>false1</code>的结果。</p>
<h4 id="d3-scaleQuantize-量化比例尺"><a href="#d3-scaleQuantize-量化比例尺" class="headerlink" title="d3.scaleQuantize() 量化比例尺"></a>d3.scaleQuantize() 量化比例尺</h4><p>属于连续性比例尺。定义域是连续的，而输出域是离散的。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> scale = d3</span><br><span class="line">  .scaleQuantize()</span><br><span class="line">  .domain([<span class="number">0</span>, <span class="number">10</span>])</span><br><span class="line">  .range([<span class="string">"晴天"</span>, <span class="string">"雨天"</span>, <span class="string">"下雪"</span>]);</span><br></pre></td></tr></table></figure>

<p>从字面意思上可以把它理解成上一段的相反函数，但是又有一点不一样（不存在的取值会向第一个或者最后一个无限延伸）<br><img src="https://user-gold-cdn.xitu.io/2019/7/13/16be8fcf19bd5af8?w=679&h=299&f=png&s=22926" alt="alt"></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">scale(<span class="number">0</span>); <span class="comment">//晴天</span></span><br><span class="line">scale(<span class="number">5</span>); <span class="comment">//雨天</span></span><br><span class="line">scale(<span class="number">6.66</span>); <span class="comment">//雨天</span></span><br><span class="line"><span class="comment">// 超过范围会向另一侧无限延伸</span></span><br><span class="line">scale(<span class="number">11</span>); <span class="comment">//下雪</span></span><br><span class="line">scale(<span class="number">-11</span>); <span class="comment">//晴天</span></span><br></pre></td></tr></table></figure>

<h4 id="d3-scaleTime-时间比例尺"><a href="#d3-scaleTime-时间比例尺" class="headerlink" title="d3.scaleTime() 时间比例尺"></a>d3.scaleTime() 时间比例尺</h4><p>类似于 d3.scaleLinear()线性比例尺，只不过输入域变成了一个时间轴。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> scale = d3</span><br><span class="line">  .scaleTime()</span><br><span class="line">  .domain([<span class="keyword">new</span> <span class="built_in">Date</span>(<span class="number">2017</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="number">2017</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>)])</span><br><span class="line">  .range([<span class="number">0</span>, <span class="number">100</span>]);</span><br><span class="line">scale(<span class="keyword">new</span> <span class="built_in">Date</span>(<span class="number">2017</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>)); <span class="comment">// 输出:0</span></span><br><span class="line">scale(<span class="keyword">new</span> <span class="built_in">Date</span>(<span class="number">2017</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>)); <span class="comment">// 输出:50</span></span><br></pre></td></tr></table></figure>

<p>时间比例尺较多用在根据时间顺序变化的数据上。另外有一个<code>d3.scaleUtc()</code>是依据世界标准时间(UTC)来计算的。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"time"</span> <span class="attr">class</span>=<span class="string">"clear"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>Linear Time Progression<span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>Mapping [01/01/2016, 12/31/2016] to [0, 1200]<span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> start = <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="number">2016</span>, <span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">  end = <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="number">2016</span>, <span class="number">11</span>, <span class="number">31</span>),</span><br><span class="line">  range = [<span class="number">0</span>, <span class="number">1200</span>], <span class="comment">//定义输出域</span></span><br><span class="line">  time = d3</span><br><span class="line">    .scaleTime()</span><br><span class="line">    .domain([start, end]) <span class="comment">// 将时间戳作为输入域传入</span></span><br><span class="line">    .rangeRound(range), <span class="comment">// 定义输出域、范围</span></span><br><span class="line">  max = <span class="number">12</span>,</span><br><span class="line">  data = [];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; max; ++i) &#123;</span><br><span class="line">  <span class="comment">// 分割时间</span></span><br><span class="line">  <span class="keyword">var</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>(start.getTime());</span><br><span class="line">  date.setMonth(start.getMonth() + i);</span><br><span class="line">  data.push(date);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">data, scale, selector</span>) </span>&#123;</span><br><span class="line">  d3.select(selector)</span><br><span class="line">    .selectAll(<span class="string">"div.fixed-cell"</span>)</span><br><span class="line">    .data(data)</span><br><span class="line">    .enter()</span><br><span class="line">    .append(<span class="string">"div"</span>)</span><br><span class="line">    .classed(<span class="string">"fixed-cell"</span>, <span class="literal">true</span>)</span><br><span class="line">    .style(<span class="string">"margin-left"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> scale(d) + <span class="string">"px"</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">    .html(<span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> format = d3.timeFormat(<span class="string">"%x"</span>); <span class="comment">// 默认时区下%m/%d/%Y时间格式化</span></span><br><span class="line">      <span class="keyword">return</span> format(d) + <span class="string">"&lt;br&gt;"</span> + scale(d) + <span class="string">"px"</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">render(data, time, <span class="string">"#time"</span>);</span><br></pre></td></tr></table></figure>

<p>使用方式和之前数据处理的方式很类似<br><img src="https://user-gold-cdn.xitu.io/2019/7/13/16be8fcf43059157?w=1335&h=210&f=png&s=31953" alt="alt"></p>
<h4 id="颜色比例尺"><a href="#颜色比例尺" class="headerlink" title="颜色比例尺"></a>颜色比例尺</h4><p>D3 提供了一些颜色比例尺，10 就是 10 种颜色，20 就是 20 种：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// d3.schemeCategory10</span></span><br><span class="line"><span class="comment">// d3.schemeCategory20</span></span><br><span class="line"><span class="comment">// d3.schemeCategory20b</span></span><br><span class="line"><span class="comment">// d3.schemeCategory20c</span></span><br><span class="line"><span class="comment">// 定义一个序数颜色比例尺</span></span><br><span class="line"><span class="keyword">let</span> color = d3.scaleOrdinal(d3.schemeCategory10);</span><br><span class="line">color(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/13/16be8fcf43867cc9?w=551&h=101&f=png&s=9237" alt="alt"><br>当然还有其他颜色的尺度</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"alphabet"</span> <span class="attr">class</span>=<span class="string">"clear"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>Ordinal Scale with Alphabet<span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>Mapping [1..10] to ["a".."j"]<span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"category10"</span> <span class="attr">class</span>=<span class="string">"clear"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>Ordinal Color Scale Category 10<span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>Mapping [1..10] to category 10 colors<span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"schemeAccent"</span> <span class="attr">class</span>=<span class="string">"clear"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>Ordinal Color Scale schemeAccent<span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>Mapping [1..10] to schemeAccent colors<span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"schemePaired"</span> <span class="attr">class</span>=<span class="string">"clear"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>Ordinal Color Scale schemePaired<span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>Mapping [1..10] to schemePaired colors<span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"schemeSet3"</span> <span class="attr">class</span>=<span class="string">"clear"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>Ordinal Color Scale schemeSet3<span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>Mapping [1..10] to schemeSet3 colors<span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> max = <span class="number">10</span>,</span><br><span class="line">  data = [];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt;= max; ++i) data.push(i);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> alphabet = d3</span><br><span class="line">  .scaleOrdinal()</span><br><span class="line">  .domain(data)</span><br><span class="line">  .range([<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>, <span class="string">"e"</span>, <span class="string">"f"</span>, <span class="string">"g"</span>, <span class="string">"h"</span>, <span class="string">"i"</span>, <span class="string">"j"</span>]);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">data, scale, selector</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> cells = d3</span><br><span class="line">    .select(selector)</span><br><span class="line">    .selectAll(<span class="string">"div.cell"</span>)</span><br><span class="line">    .data(data);</span><br><span class="line">  cells</span><br><span class="line">    .enter()</span><br><span class="line">    .append(<span class="string">"div"</span>)</span><br><span class="line">    .classed(<span class="string">"cell"</span>, <span class="literal">true</span>)</span><br><span class="line">    .style(<span class="string">"display"</span>, <span class="string">"inline-block"</span>)</span><br><span class="line">    .style(<span class="string">"background-color"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> scale(d).indexOf(<span class="string">"#"</span>) &gt;= <span class="number">0</span> ? scale(d) : <span class="string">"white"</span>; <span class="comment">// 十六进制颜色</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .text(<span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> scale(d);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">render(data, alphabet, <span class="string">"#alphabet"</span>);</span><br><span class="line">render(data, d3.scaleOrdinal(d3.schemeCategory10), <span class="string">"#category10"</span>);</span><br><span class="line">render(data, d3.scaleOrdinal(d3.schemeAccent), <span class="string">"#schemeAccent"</span>);</span><br><span class="line">render(data, d3.scaleOrdinal(d3.schemePaired), <span class="string">"#schemePaired"</span>);</span><br><span class="line">render(data, d3.scaleOrdinal(d3.schemeSet3), <span class="string">"#schemeSet3"</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/13/16be8fcf48360099?w=1001&h=526&f=png&s=130772" alt="alt"><br>颜色插值<br>在这里面有个点要注意</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">d3.scaleLinear()</span><br><span class="line">  .domain([<span class="number">0</span>, pivot, max])</span><br><span class="line">  .range([<span class="string">"white"</span>, <span class="string">"#4169e1"</span>, <span class="string">"white"</span>]);</span><br><span class="line"><span class="comment">// 等同于</span></span><br><span class="line">d3.scaleLinear()</span><br><span class="line">  .domain([<span class="number">0</span>, pivot])</span><br><span class="line">  .range([<span class="string">"white"</span>, <span class="string">"#4169e1"</span>]);</span><br><span class="line"><span class="comment">// 和</span></span><br><span class="line">d3.scaleLinear()</span><br><span class="line">  .domain([pivot, max])</span><br><span class="line">  .range([<span class="string">"#4169e1"</span>, <span class="string">"white"</span>]);</span><br></pre></td></tr></table></figure>

<h4 id="其他比例尺"><a href="#其他比例尺" class="headerlink" title="其他比例尺"></a>其他比例尺</h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">d3.scaleIdentity(); <span class="comment">// 恒等比例尺</span></span><br><span class="line">d3.scaleSqrt(); <span class="comment">// 乘方比例尺</span></span><br><span class="line">d3.scalePow(); <span class="comment">// 类似scaleSqrt的乘方比例尺</span></span><br><span class="line">d3.scaleLog(); <span class="comment">// 对数比例尺</span></span><br><span class="line">d3.scaleQuantile(); <span class="comment">// 分位数比例尺</span></span><br></pre></td></tr></table></figure>

<h4 id="invert-与-invertExtent-方法"><a href="#invert-与-invertExtent-方法" class="headerlink" title="invert()与 invertExtent()方法"></a>invert()与 invertExtent()方法</h4><p>上述的各种使用比例尺的例子都相当于一个正序的过程，从<code>domain</code>的数据集映射到<code>range</code>数据集中，那么有没有逆序从<code>range</code>取值的过程呢？<br><code>invert()</code>适用于连续型<code>[0,100]</code>类型数据，以及<code>invertExtent()</code>使用与离散型数据<code>[&#39;apple&#39;,&#39;orange&#39;]</code>方法可以实现。<br>这两种方法只针对连续性比例尺有效，即<code>domain()</code>域为连续性数据集的比例尺。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> scale = d3</span><br><span class="line">  .scaleLinear()</span><br><span class="line">  .domain([<span class="number">1</span>, <span class="number">5</span>])</span><br><span class="line">  .range([<span class="number">0</span>, <span class="number">100</span>]);</span><br><span class="line">scale.invert(<span class="number">50</span>); <span class="comment">// 输出:3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> scale2 = d3</span><br><span class="line">  .scaleQuantize()</span><br><span class="line">  .domain([<span class="number">0</span>, <span class="number">10</span>])</span><br><span class="line">  .range([<span class="string">"small"</span>, <span class="string">"big"</span>]);</span><br><span class="line">scale2.invertExtent(<span class="string">"small"</span>); <span class="comment">// 输出:[0,5]</span></span><br></pre></td></tr></table></figure>



<p>接下来我们会基于<code>Vue</code>去学习 d3 示例图，这并不是说 Vue 适合，因为笔者懒，赋值方便,写 css 也方便…嘿嘿 ^_^</p>
<h3 id="坐标轴"><a href="#坐标轴" class="headerlink" title="坐标轴"></a>坐标轴</h3><p>首先是坐标轴，首先要看你需要渲染什么样的数据，比如你需要渲染时间类型的，那 X 轴就可以用刚才学到的<code>scaleTime()</code>时间比例尺,如果是序列数据则适合<code>scaleBand()</code>序数或指数比例尺,比例尺语法在上面基础知识已经学习过，在这里不做过多赘述，直接开撸</p>
<p>首先自然是定义一个容器,为确保唯一性，我们可以根据 ref 来选择元素容器。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">"axis"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后在<code>mounted</code>里调用方法</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">mounted()&#123;</span><br><span class="line">  <span class="keyword">const</span> svg = d3.select(<span class="keyword">this</span>.$refs.axis).append(<span class="string">'svg'</span>).attr(<span class="string">'width'</span>,<span class="number">500</span>).attr(<span class="string">'height'</span>,<span class="number">500</span>)</span><br><span class="line">  <span class="keyword">const</span> axis = svg.append(<span class="string">"g"</span>).attr(<span class="string">"transform"</span>, <span class="string">"translate(50,50)"</span>)</span><br><span class="line">  <span class="comment">// y轴比例尺，在0-400px的宽度里，映射的值为0-1000</span></span><br><span class="line">  <span class="keyword">const</span> yScale = d3.scaleLinear().domain([<span class="number">0</span>, <span class="number">1000</span>]).range([<span class="number">0</span>, <span class="number">400</span>]);</span><br><span class="line">  <span class="comment">// 坐标轴生成器，映射该比例尺，刻度个数设定为5个，默认为自动去零取整</span></span><br><span class="line">  <span class="keyword">const</span> yAxis = d3.axisLeft().scale(yScale).ticks(<span class="number">5</span>)</span><br><span class="line">  <span class="comment">// 用g元素应用坐标轴生成器,位移一段距离，因为应用的是axisLeft，左侧坐标轴，刻度在左边</span></span><br><span class="line">  axis.append(<span class="string">"g"</span>).call(yAxis);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// x轴</span></span><br><span class="line">  <span class="keyword">const</span> xList = [<span class="string">'1月份'</span>,<span class="string">'2月份'</span>,<span class="string">'3月份'</span>,<span class="string">'4月份'</span>]</span><br><span class="line">  <span class="comment">// 同样将数组映射到range([0,450])之间</span></span><br><span class="line">  <span class="keyword">const</span> xScale = d3.scaleBand().domain(xList).range([<span class="number">0</span>,<span class="number">450</span>])</span><br><span class="line">  <span class="comment">// 由于是序数比例尺，输入域没有一个可遵循的顺序，ticks无效，不能指定</span></span><br><span class="line">  <span class="keyword">const</span> xAxis = d3.axisBottom().scale(xScale)</span><br><span class="line">  <span class="comment">// 同样,执行坐标轴生成器</span></span><br><span class="line">  axis.append(<span class="string">"g"</span>).call(xAxis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/13/16bea063df5265cf?w=490&h=430&f=png&s=8622" alt="alt"></p>
<p>为什么会在上面？<br>因为 d3 并没有去控制一个图表内坐标轴的数量，所以默认都是左上方，也就是 svg 的’默认规定’</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">svg</span><br><span class="line">  .append(<span class="string">"g"</span>)</span><br><span class="line">  .attr(<span class="string">"transform"</span>, <span class="string">"translate(0,400)"</span>)</span><br><span class="line">  .call(xAxis);</span><br></pre></td></tr></table></figure>

<p>只需要位移 y 轴的高度即可</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/7/13/16bea05464fa9373?w=518&h=455&f=png&s=9265" alt="alt"></p>
<p>四个比例尺方向你可能会搞混，实际上只要这么记: 你想要刻度数值出现在刻度尺的什么方向，比如要底部的刻度尺，它的数值在下方，那它就是 axisBottom….</p>
<details>
  <summary>全部代码</summary>

<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;button @click=<span class="string">"renderAll('d3.axisBottom')"</span>&gt;横向向下&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">  &lt;button @click="renderAll('d3.axisTop')"&gt;横向向上&lt;/</span>button&gt;</span><br><span class="line">  &lt;button @click=<span class="string">"renderAll('d3.axisLeft')"</span>&gt;纵向向左&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">  &lt;button @click="renderAll('d3.axisRight')"&gt;纵向向右 &lt;/</span>button&gt;</span><br><span class="line">  &lt;div ref=<span class="string">'axis'</span>&gt;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>template&gt;</span><br><span class="line"></span><br><span class="line">data() &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    height: <span class="number">500</span>,</span><br><span class="line">    width: <span class="number">500</span>,</span><br><span class="line">    margin: <span class="number">25</span>,</span><br><span class="line">    offset: <span class="number">50</span>,</span><br><span class="line">    axisWidth: <span class="number">450</span>,</span><br><span class="line">    svg: <span class="string">""</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;,</span><br><span class="line">methods: &#123;</span><br><span class="line">  createSvg() &#123;</span><br><span class="line">    <span class="keyword">this</span>.svg = d3</span><br><span class="line">      .select(<span class="keyword">this</span>.$refs.axis)</span><br><span class="line">      .append(<span class="string">"svg"</span>) <span class="comment">// 重新创建svg</span></span><br><span class="line">      .attr(<span class="string">"class"</span>, <span class="string">"axis"</span>)</span><br><span class="line">      .attr(<span class="string">"width"</span>, <span class="keyword">this</span>.width)</span><br><span class="line">      .attr(<span class="string">"height"</span>, <span class="keyword">this</span>.height);</span><br><span class="line">  &#125;,</span><br><span class="line">  renderAxis(fn, scale, i) &#123;</span><br><span class="line">    <span class="keyword">const</span> _this = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> axis = <span class="built_in">eval</span>(fn)() <span class="comment">// 将传入的字符串转成变量</span></span><br><span class="line">      .scale(scale) <span class="comment">// 设置尺度</span></span><br><span class="line">      .ticks(<span class="number">5</span>); <span class="comment">// 分5段，但不是绝对，下一章会讲</span></span><br><span class="line">    <span class="keyword">this</span>.svg</span><br><span class="line">      .append(<span class="string">"g"</span>)</span><br><span class="line">      .attr(<span class="string">"transform"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 根据纵向或者横向设置demo位置</span></span><br><span class="line">        <span class="keyword">if</span> ([d3.axisTop, d3.axisBottom].indexOf(<span class="built_in">eval</span>(fn)) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="comment">// 如果是横向坐标轴，则设置位置</span></span><br><span class="line">          <span class="keyword">return</span> <span class="string">`translate(<span class="subst">$&#123;_this.margin&#125;</span>,<span class="subst">$&#123;i * _this.offset&#125;</span>)`</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="string">`translate(<span class="subst">$&#123;i * _this.offset&#125;</span>,<span class="subst">$&#123;_this.margin&#125;</span>)`</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      .call(axis); <span class="comment">// 转成坐标轴</span></span><br><span class="line">  &#125;,</span><br><span class="line">  renderAll(fn) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.svg) <span class="keyword">this</span>.svg.remove();</span><br><span class="line">    <span class="comment">// 擦除，重新创建</span></span><br><span class="line">    <span class="keyword">this</span>.createSvg();</span><br><span class="line">    <span class="keyword">let</span> scale = d3 <span class="comment">// 线性坐标轴</span></span><br><span class="line">      .scaleLinear()</span><br><span class="line">      .domain([<span class="number">0</span>, <span class="number">1000</span>])</span><br><span class="line">      .range([<span class="number">0</span>, <span class="keyword">this</span>.axisWidth]);</span><br><span class="line">    <span class="keyword">this</span>.renderAxis(fn, scale, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> scalePow = d3 <span class="comment">// 幂级尺度坐标轴，显示的值范围偏中上，0-200之间显示的较少，600-1000之间占据显示的空间较多</span></span><br><span class="line">      .scalePow()</span><br><span class="line">      .exponent(<span class="number">2</span>) <span class="comment">// 2次方 根号</span></span><br><span class="line">      .domain([<span class="number">0</span>, <span class="number">1000</span>])</span><br><span class="line">      .range([<span class="number">0</span>, <span class="keyword">this</span>.axisWidth]);</span><br><span class="line">    <span class="keyword">this</span>.renderAxis(fn, scalePow, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> scaleTime = d3 <span class="comment">// 时间尺度</span></span><br><span class="line">      .scaleTime()</span><br><span class="line">      .domain([<span class="keyword">new</span> <span class="built_in">Date</span>(<span class="number">2016</span>, <span class="number">0</span>, <span class="number">1</span>), <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="number">2017</span>, <span class="number">0</span>, <span class="number">1</span>)])</span><br><span class="line">      .range([<span class="number">0</span>, <span class="keyword">this</span>.axisWidth]);</span><br><span class="line">    <span class="keyword">this</span>.renderAxis(fn, scaleTime, <span class="number">3</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</details>

<h3 id="网格型的坐标轴"><a href="#网格型的坐标轴" class="headerlink" title="网格型的坐标轴"></a>网格型的坐标轴</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"gridLineSvg"</span>/&gt;</span><br><span class="line">&lt;<span class="regexp">/template&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">import * as d3 from 'd3'</span></span><br><span class="line"><span class="regexp">export default &#123;</span></span><br><span class="line"><span class="regexp">  data() &#123;</span></span><br><span class="line"><span class="regexp">    return &#123;</span></span><br><span class="line"><span class="regexp">      height: 500,</span></span><br><span class="line"><span class="regexp">        width: 500,</span></span><br><span class="line"><span class="regexp">        margin: 25,</span></span><br><span class="line"><span class="regexp">        max: 100,</span></span><br><span class="line"><span class="regexp">        yAxis: null,</span></span><br><span class="line"><span class="regexp">        xAxis: null,</span></span><br><span class="line"><span class="regexp">        gridAxis: null</span></span><br><span class="line"><span class="regexp">    &#125;;</span></span><br><span class="line"><span class="regexp">  &#125;,</span></span><br><span class="line"><span class="regexp">  mounted() &#123;</span></span><br><span class="line"><span class="regexp">    const _this = this;</span></span><br><span class="line"><span class="regexp">    const &#123; max, width, height, margin &#125; = this;</span></span><br><span class="line"><span class="regexp">    var svg = d3</span></span><br><span class="line"><span class="regexp">      .select(".gridLineSvg")</span></span><br><span class="line"><span class="regexp">      .append("svg")</span></span><br><span class="line"><span class="regexp">      .attr("class", "axis")</span></span><br><span class="line"><span class="regexp">      .attr("width", width)</span></span><br><span class="line"><span class="regexp">      .attr("height", height);</span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ 坐标轴容器</span></span><br><span class="line"><span class="regexp">    const axis = svg.append("g").attr("transform", `translate($&#123;margin&#125;,$&#123;margin&#125;)`);</span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ 计算x轴和y轴的宽度和长度</span></span><br><span class="line"><span class="regexp">    let yAxisLength = height - 2 * margin;</span></span><br><span class="line"><span class="regexp">    let xAxisLength = width - 2 * margin;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ 绘制网格的X轴</span></span><br><span class="line"><span class="regexp">    function renderXAxis() &#123;</span></span><br><span class="line"><span class="regexp">      let scale = d3.scaleLinear().domain([0, max]).range([0, xAxisLength]);</span></span><br><span class="line"><span class="regexp">      let xAxis = d3.axisBottom().scale(scale);</span></span><br><span class="line"><span class="regexp">      /</span><span class="regexp">/ 保存坐标轴生成器，以便更新时调用</span></span><br><span class="line"><span class="regexp">      _this.xAxis = xAxis</span></span><br><span class="line"><span class="regexp">      axis.append("g")</span></span><br><span class="line"><span class="regexp">        .attr("class", "x-axis")</span></span><br><span class="line"><span class="regexp">        .attr("transform",  `translate($0,$&#123;yAxisLength&#125;)`)</span></span><br><span class="line"><span class="regexp">        .call(xAxis);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">      d3.selectAll("g.x-axis g.tick") /</span><span class="regexp">/ 拿到所有刻度</span></span><br><span class="line"><span class="regexp">        .append("line") /</span><span class="regexp">/ 添加线条</span></span><br><span class="line"><span class="regexp">        .classed("grid-line", true) /</span><span class="regexp">/ 添加class</span></span><br><span class="line"><span class="regexp">        .attr("x1", 0).attr("y1", 0) /</span><span class="regexp">/ 创建线x1,y1为起点以及x2,y2为终点</span></span><br><span class="line"><span class="regexp">        .attr("x2", 0).attr("y2", -(yAxisLength));</span></span><br><span class="line"><span class="regexp">      /</span><span class="regexp">/ 为负是因为现在的g元素已经通过上面的translate整体位移了，g元素代表分组，和css原理类似</span></span><br><span class="line"><span class="regexp">      /</span><span class="regexp">/ 到svg:g元素里创建一个点(0,0)，会发现它的真实位置依赖了父元素的translate</span></span><br><span class="line"><span class="regexp">      /</span><span class="regexp">/ 所以我们希望通过 -yAxisLength 的形式来将其设置为反方向</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ Y轴同理</span></span><br><span class="line"><span class="regexp">    function renderYAxis() &#123;</span></span><br><span class="line"><span class="regexp">      let scale = d3.scaleLinear().domain([max, 0]).range([0, yAxisLength]);</span></span><br><span class="line"><span class="regexp">      let yAxis = d3.axisLeft().scale(scale);</span></span><br><span class="line"><span class="regexp">      _this.yAxis = yAxis;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">      axis.append("g").attr("class", "y-axis").call(yAxis);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">      /</span><span class="regexp">/ 这里我们也可以使用坐标轴生成器，根据设置刻度尺tickSize的大小代替line</span></span><br><span class="line"><span class="regexp">      const gridAxis = d3</span></span><br><span class="line"><span class="regexp">        .axisLeft()</span></span><br><span class="line"><span class="regexp">        .scale(scale)</span></span><br><span class="line"><span class="regexp">        .tickSize(-xAxisLength)</span></span><br><span class="line"><span class="regexp">        .tickFormat(""); /</span><span class="regexp">/ 格式化刻度数值，这里不允许它显示刻度</span></span><br><span class="line"><span class="regexp">      _this.gridAxis = gridAxis;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">      axis.append("g").attr("class", "grid-y-axis").call(gridAxis);</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    renderYAxis();</span></span><br><span class="line"><span class="regexp">    renderXAxis();</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;style&gt;</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 主坐标轴都是path，刻度尺都是line</span></span><br><span class="line"><span class="regexp">.tick line,</span></span><br><span class="line"><span class="regexp">.x-axis path,</span></span><br><span class="line"><span class="regexp">.y-axis path &#123;</span></span><br><span class="line"><span class="regexp">  stroke: #e8e8e8;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">.grid-y-axis path &#123;</span></span><br><span class="line"><span class="regexp">  display: none;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">&lt;/</span>style&gt;</span><br></pre></td></tr></table></figure>

<p>就可以得到这样的效果</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/7/13/16bea532253c7e61?w=500&h=486&f=png&s=11082" alt="alt"></p>
<h3 id="让坐标轴动起来"><a href="#让坐标轴动起来" class="headerlink" title="让坐标轴动起来"></a>让坐标轴动起来</h3><p>我们在 methods 里添加一个事件，去动态的改变它的值域</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">methods: &#123;</span><br><span class="line">    change() &#123;</span><br><span class="line">      <span class="keyword">this</span>.yAxis.scale().domain([<span class="built_in">Math</span>.random() * <span class="number">1000</span>, <span class="number">0</span>]);</span><br><span class="line">      <span class="keyword">this</span>.xAxis.scale().domain([<span class="number">0</span>,<span class="built_in">Math</span>.random() * <span class="number">1000</span>]);</span><br><span class="line">      <span class="keyword">this</span>.gridAxis.scale().domain([<span class="built_in">Math</span>.random() * <span class="number">1000</span>, <span class="number">0</span>]);</span><br><span class="line">      d3.select(<span class="string">".y-axis"</span>).transition().duration(<span class="number">500</span>).call(<span class="keyword">this</span>.yAxis);</span><br><span class="line">      d3.select(<span class="string">".x-axis"</span>).transition().duration(<span class="number">500</span>).call(<span class="keyword">this</span>.xAxis);</span><br><span class="line">      d3.select(<span class="string">".grid-y-axis"</span>).transition().duration(<span class="number">500</span>).call(<span class="keyword">this</span>.gridAxis);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/13/16bea60045c69750?w=507&h=524&f=gif&s=287886" alt="alt"></p>
<p>会发现 y 轴的 grid 是正常的，而 x 轴的 grid 值域还在之前的值，上面我们通过</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">this</span>.gridAxis.scale().domain([<span class="built_in">Math</span>.random() * <span class="number">1000</span>, <span class="number">0</span>]);</span><br><span class="line">d3.select(<span class="string">".grid-y-axis"</span>)</span><br><span class="line">  .transition()</span><br><span class="line">  .duration(<span class="number">500</span>)</span><br><span class="line">  .call(<span class="keyword">this</span>.gridAxis);</span><br></pre></td></tr></table></figure>

<p>去更新了 y 轴的 grid，因为它是基于坐标轴的，比较好设置，而 x 轴上是动态添加的 line 元素，其补集和删集的动画虽然可以实现，但是要配合 ticks 的动画就难以做到了。所以在这里建议 y 轴和 x 轴的 grid 都使用 axis 去做，以配合动画的效果。</p>
<p>最终网格坐标轴效果</p>
<details>
  <summary>实例代码</summary>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div id=<span class="string">"app"</span>&gt;</span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"gridLineSvg"</span>/&gt;</span><br><span class="line">    &lt;button @click=<span class="string">"change"</span>&gt;change domain&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>div&gt;</span><br><span class="line">&lt;<span class="regexp">/template&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;script&gt;</span></span><br><span class="line"><span class="regexp">import * as d3 from "d3";</span></span><br><span class="line"><span class="regexp">export default &#123;</span></span><br><span class="line"><span class="regexp">  name: "App",</span></span><br><span class="line"><span class="regexp">  data() &#123;</span></span><br><span class="line"><span class="regexp">    return &#123;</span></span><br><span class="line"><span class="regexp">      height: 500,</span></span><br><span class="line"><span class="regexp">      width: 500,</span></span><br><span class="line"><span class="regexp">      margin: 30,</span></span><br><span class="line"><span class="regexp">      max: 100,</span></span><br><span class="line"><span class="regexp">      yAxis: null,</span></span><br><span class="line"><span class="regexp">      gridYAxis: null,</span></span><br><span class="line"><span class="regexp">      gridXAxis: null</span></span><br><span class="line"><span class="regexp">    &#125;;</span></span><br><span class="line"><span class="regexp">  &#125;,</span></span><br><span class="line"><span class="regexp">  methods: &#123;</span></span><br><span class="line"><span class="regexp">    change() &#123;</span></span><br><span class="line"><span class="regexp">      const xVal = [0,Math.random() * 1000]</span></span><br><span class="line"><span class="regexp">      const yVal = [Math.random() * 1000,0]</span></span><br><span class="line"><span class="regexp">      this.yAxis.scale().domain(yVal);</span></span><br><span class="line"><span class="regexp">      this.xAxis.scale().domain(xVal);</span></span><br><span class="line"><span class="regexp">      this.gridYAxis.scale().domain(yVal);</span></span><br><span class="line"><span class="regexp">      this.gridXAxis.scale().domain(xVal);</span></span><br><span class="line"><span class="regexp">      d3.select(".y-axis").transition().duration(500).call(this.yAxis);</span></span><br><span class="line"><span class="regexp">      d3.select(".x-axis").transition().duration(500).call(this.xAxis);</span></span><br><span class="line"><span class="regexp">      d3.select(".grid-y-axis").transition().duration(500).call(this.gridYAxis);</span></span><br><span class="line"><span class="regexp">      d3.select(".grid-x-axis").transition().duration(500).call(this.gridXAxis);</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">  &#125;,</span></span><br><span class="line"><span class="regexp">  mounted() &#123;</span></span><br><span class="line"><span class="regexp">    const _this = this;</span></span><br><span class="line"><span class="regexp">    const &#123; max, width, height, margin &#125; = this;</span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ 计算x轴和y轴的宽度和长度</span></span><br><span class="line"><span class="regexp">    let yAxisLength = height - 2 * margin;</span></span><br><span class="line"><span class="regexp">    let xAxisLength = width - 2 * margin;</span></span><br><span class="line"><span class="regexp">    var svg = d3</span></span><br><span class="line"><span class="regexp">      .select(".gridLineSvg")</span></span><br><span class="line"><span class="regexp">      .append("svg")</span></span><br><span class="line"><span class="regexp">      .attr("class", "axis")</span></span><br><span class="line"><span class="regexp">      .attr("width", width)</span></span><br><span class="line"><span class="regexp">      .attr("height", height);</span></span><br><span class="line"><span class="regexp">    const axis = svg</span></span><br><span class="line"><span class="regexp">      .append("g")</span></span><br><span class="line"><span class="regexp">      .attr("transform", `translate($&#123;margin&#125;,$&#123;margin&#125;)`);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ 绘制网格的X轴</span></span><br><span class="line"><span class="regexp">    function renderXAxis() &#123;</span></span><br><span class="line"><span class="regexp">      let scale = d3</span></span><br><span class="line"><span class="regexp">        .scaleLinear()</span></span><br><span class="line"><span class="regexp">        .domain([0, max])</span></span><br><span class="line"><span class="regexp">        .range([0, xAxisLength]);</span></span><br><span class="line"><span class="regexp">      let xAxis = d3.axisBottom().scale(scale);</span></span><br><span class="line"><span class="regexp">      /</span><span class="regexp">/ 保存坐标轴生成器</span></span><br><span class="line"><span class="regexp">      _this.xAxis = xAxis;</span></span><br><span class="line"><span class="regexp">      axis</span></span><br><span class="line"><span class="regexp">        .append("g")</span></span><br><span class="line"><span class="regexp">        .attr("class", "x-axis")</span></span><br><span class="line"><span class="regexp">        .attr("transform", `translate(0,$&#123;yAxisLength&#125;)`)</span></span><br><span class="line"><span class="regexp">        .call(xAxis);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">      const gridXAxis = d3</span></span><br><span class="line"><span class="regexp">        .axisBottom()</span></span><br><span class="line"><span class="regexp">        .scale(scale)</span></span><br><span class="line"><span class="regexp">        .tickSize(yAxisLength)</span></span><br><span class="line"><span class="regexp">        .tickFormat(""); /</span><span class="regexp">/ 格式化刻度数值，这里不允许它显示刻度</span></span><br><span class="line"><span class="regexp">      _this.gridXAxis = gridXAxis;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">      axis</span></span><br><span class="line"><span class="regexp">        .append("g")</span></span><br><span class="line"><span class="regexp">        .attr("class", "grid-x-axis")</span></span><br><span class="line"><span class="regexp">        .call(gridXAxis);</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ Y轴同理</span></span><br><span class="line"><span class="regexp">    function renderYAxis() &#123;</span></span><br><span class="line"><span class="regexp">      let scale = d3.scaleLinear().domain([max, 0]).range([0, yAxisLength]);</span></span><br><span class="line"><span class="regexp">      let yAxis = _this.yAxis = d3.axisLeft().scale(scale);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">      axis.append("g").attr("class", "y-axis").call(yAxis);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">      /</span><span class="regexp">/ 这里我们也可以使用坐标轴生成器，根据设置刻度尺tickSize的大小代替line</span></span><br><span class="line"><span class="regexp">      const gridYAxis = d3</span></span><br><span class="line"><span class="regexp">        .axisLeft()</span></span><br><span class="line"><span class="regexp">        .scale(scale)</span></span><br><span class="line"><span class="regexp">        .tickSize(-xAxisLength)</span></span><br><span class="line"><span class="regexp">        .tickFormat(""); /</span><span class="regexp">/ 格式化刻度数值，这里不允许它显示刻度</span></span><br><span class="line"><span class="regexp">      _this.gridYAxis = gridYAxis;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">      axis.append("g").attr("class", "grid-y-axis").call(gridYAxis);</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    renderYAxis();</span></span><br><span class="line"><span class="regexp">    renderXAxis();</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp">&lt;/</span>script&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">.tick line,</span><br><span class="line">.x-axis path,</span><br><span class="line">.y-axis path &#123;</span><br><span class="line">  stroke: #e8e8e8;</span><br><span class="line">&#125;</span><br><span class="line">.grid-y-axis path,</span><br><span class="line">.grid-x-axis path &#123;</span><br><span class="line">  display: none;</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/style&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="折线图"><a href="#折线图" class="headerlink" title="折线图"></a>折线图</h2><p>看完了坐标轴，相信折线图你已经会画了一半，接下来我们将基于Vue开发带交互，动画的折线图<br>在此之前，我们了解一下布局，在接下来的过程中，我们都将使用Vue的computed属性计算其各位置，举例<br>我们定义<code>margin:{top:100,right:80,bottom:50,left:70}</code>对应<br><img src="https://static.yuanziwen.cn/blog/d3Line/1.png_plain" alt="alt"></p>
<p>首先我们定义所需要的数据模板和数据源</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div ref=<span class="string">"lineChart"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"lineChart"</span>/&gt;</span><br><span class="line">&lt;<span class="regexp">/template&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;script&gt;</span></span><br><span class="line"><span class="regexp">import * as d3 from 'd3';</span></span><br><span class="line"><span class="regexp">import &#123; colorList &#125; from '@/u</span>tils/index<span class="string">';</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">export default &#123;</span></span><br><span class="line"><span class="string">  name: '</span>lineChart<span class="string">',</span></span><br><span class="line"><span class="string">  data() &#123;</span></span><br><span class="line"><span class="string">    return &#123;</span></span><br><span class="line"><span class="string">      color: Object.freeze(colorList()),// 利用颜色比例尺封装的一百多种颜色，上文有</span></span><br><span class="line"><span class="string">      height: 400,</span></span><br><span class="line"><span class="string">      width: 600,</span></span><br><span class="line"><span class="string">      svg: null, // svg实例</span></span><br><span class="line"><span class="string">      chart: null, // 折线图对象</span></span><br><span class="line"><span class="string">      xScale: null, // x轴比例尺，可以通过xScale('</span><span class="number">2.1</span><span class="string">') 获取该日期在x轴上应处于的横坐标位置(px)</span></span><br><span class="line"><span class="string">      yScale: null, // y轴比例尺，可以通过yScale(50)    获取到该值处于y轴上的纵坐标位置(px)</span></span><br><span class="line"><span class="string">      xAxis: null, // x坐标轴，可以通过xAxis.scale().domain(xList) 更新x轴及其值域</span></span><br><span class="line"><span class="string">      yAxis: null, // x坐标轴，可以通过yAxis.scale().domain([max,0]) 更新y轴及其值域</span></span><br><span class="line"><span class="string">      gridAxis: null, // y轴刻度线，配合y轴的辅助线，使用方法和y轴相同</span></span><br><span class="line"><span class="string">      stackedAreaChart: null, // 存储的svg图表生成器，自定义封装方法，和d3的API无关</span></span><br><span class="line"><span class="string">      margin: &#123; // svg的内边距，用于控制上下左右间距</span></span><br><span class="line"><span class="string">        left: 40,</span></span><br><span class="line"><span class="string">        right: 20,</span></span><br><span class="line"><span class="string">        top: 20,</span></span><br><span class="line"><span class="string">        bottom: 20</span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">      copyData: [], // 拷贝数据源，交互时避免修改数据源</span></span><br><span class="line"><span class="string">    &#125;;</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  props: &#123;</span></span><br><span class="line"><span class="string">    data: &#123;</span></span><br><span class="line"><span class="string">      type: Array,</span></span><br><span class="line"><span class="string">      default() &#123;</span></span><br><span class="line"><span class="string">        return mock(&#123;</span></span><br><span class="line"><span class="string">          '</span>list|<span class="number">5</span><span class="string">': [</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">              '</span>name|+<span class="number">1</span><span class="string">': ['</span>天猫<span class="string">', '</span>网易严选<span class="string">', '</span>云集<span class="string">', '</span>京东<span class="string">', '</span>唯品会<span class="string">'],</span></span><br><span class="line"><span class="string">              '</span>dataList|<span class="number">10</span><span class="string">': [</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                  '</span>date|+<span class="number">1</span><span class="string">': ['</span><span class="number">2.1</span><span class="string">', '</span><span class="number">2.2</span><span class="string">', '</span><span class="number">2.3</span><span class="string">', '</span><span class="number">2.4</span><span class="string">', '</span><span class="number">2.5</span><span class="string">', '</span><span class="number">2.6</span><span class="string">', '</span><span class="number">2.7</span><span class="string">', '</span><span class="number">2.8</span><span class="string">', '</span><span class="number">2.9</span><span class="string">', '</span><span class="number">2.10</span><span class="string">'],</span></span><br><span class="line"><span class="string">                  '</span>value|<span class="number">10</span><span class="number">-100</span><span class="string">': 1000</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">              ]</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">          ]</span></span><br><span class="line"><span class="string">        &#125;).list;</span></span><br><span class="line"><span class="string">        /*最终数据结构</span></span><br><span class="line"><span class="string">        [&#123;</span></span><br><span class="line"><span class="string">          name:'</span>天猫<span class="string">',</span></span><br><span class="line"><span class="string">          dataList:[</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">              date:'</span><span class="number">2.1</span><span class="string">',</span></span><br><span class="line"><span class="string">              value:500</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">              date:'</span><span class="number">2.2</span><span class="string">',</span></span><br><span class="line"><span class="string">              value:436</span></span><br><span class="line"><span class="string">            &#125;...</span></span><br><span class="line"><span class="string">          ]</span></span><br><span class="line"><span class="string">        &#125;...]</span></span><br><span class="line"><span class="string">        */</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  computed: &#123;</span></span><br><span class="line"><span class="string">     xStart() &#123; // 图表x水平方向起点，并未svg</span></span><br><span class="line"><span class="string">      return this.margin.left;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    xEnd() &#123; // 图表x水平终点</span></span><br><span class="line"><span class="string">      return this.width - this.margin.right;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    yStart() &#123; // y轴起点</span></span><br><span class="line"><span class="string">      return this.margin.top;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    yEnd() &#123; // y轴终点</span></span><br><span class="line"><span class="string">      return this.height - this.margin.bottom;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    chartHeight() &#123;  // 图表高度</span></span><br><span class="line"><span class="string">      return this.height - this.margin.top - this.margin.bottom;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    chartWidth() &#123; // 图表宽度</span></span><br><span class="line"><span class="string">      return this.width - this.margin.left - this.margin.right;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    xLineList() &#123; // x轴值域 ['</span><span class="number">2.1</span><span class="string">','</span><span class="number">2.2</span><span class="string">','</span><span class="number">2.3</span><span class="string">'....] 为了方便直接提取出来</span></span><br><span class="line"><span class="string">      return this.data[0].dataList.map(item =&gt; item.date)</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    max() &#123; // 所有队列的最大值，用于设置y轴最大值域</span></span><br><span class="line"><span class="string">      return Math.max(...this.copyData.map(item =&gt; Math.max(...item.dataList.map(ite =&gt; ite.value))))</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  methods:&#123;</span></span><br><span class="line"><span class="string">    init()&#123;</span></span><br><span class="line"><span class="string">      // ...</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  mounted()&#123;</span></span><br><span class="line"><span class="string">    this.init()</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>接下来封装方法，绘制坐标轴</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">init()&#123;</span><br><span class="line">  <span class="keyword">const</span> _this = <span class="keyword">this</span>;<span class="comment">//d3内，很容易被select和append改变this，这里要保存this指向</span></span><br><span class="line">  <span class="keyword">this</span>.stackedAreaChart = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 将计算结果导入</span></span><br><span class="line">    <span class="keyword">const</span> &#123; width, height, color, margins, xStart, yStart, xEnd, yEnd, chartHeight, max, chartWidth, xLineList&#125; = _this</span><br><span class="line">    <span class="keyword">const</span> chart = &#123;&#125; <span class="comment">// 图表实例</span></span><br><span class="line">    <span class="keyword">let</span> _data = []</span><br><span class="line">    <span class="keyword">let</span> xScale</span><br><span class="line">    <span class="keyword">let</span> yScale</span><br><span class="line">    <span class="keyword">let</span> xAxis</span><br><span class="line">    <span class="keyword">let</span> yAxis</span><br><span class="line">    <span class="keyword">let</span> _svg <span class="comment">// svg实例</span></span><br><span class="line">    <span class="keyword">let</span> _bodyG <span class="comment">// 折线图主体</span></span><br><span class="line">    _chart.render = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="comment">// 生成画布</span></span><br><span class="line">      d3.select(_this.$refs.lineChart).selectAll(<span class="string">'svg'</span>).remove() <span class="comment">// 防止再次绘制</span></span><br><span class="line">      _this.svg = _svg = d3.select(_this.$refs.lineChart).append(<span class="string">'svg'</span>).attr(<span class="string">'height'</span>, height).attr(<span class="string">'width'</span>, width)</span><br><span class="line">      <span class="keyword">return</span> _chart <span class="comment">// 将实例返回，以便链式调用剩余办法</span></span><br><span class="line">    &#125;</span><br><span class="line">    _chart.renderAxes = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> axesG = _svg.append(<span class="string">'g'</span>).attr(<span class="string">'class'</span>, <span class="string">'axes'</span>)</span><br><span class="line">      <span class="comment">// 渲染X和Y轴</span></span><br><span class="line">      xScale = d3.scaleBand().range([<span class="number">0</span>, chartWidth]).domain(xLineList)</span><br><span class="line">      yScale = d3.scaleLinear().range([<span class="number">0</span>, chartHeight]).domain([max, <span class="number">0</span>])</span><br><span class="line">      xAxis = d3.axisBottom().scale(xScale)</span><br><span class="line">      yAxis = d3.axisLeft().scale(yScale)</span><br><span class="line">      axesG.append(<span class="string">'g'</span>).attr(<span class="string">'class'</span>, <span class="string">'xAxis'</span>)</span><br><span class="line">        .attr(<span class="string">'transform'</span>, () =&gt; <span class="string">`translate(<span class="subst">$&#123;xStart&#125;</span>,<span class="subst">$&#123;yEnd&#125;</span>)`</span>) <span class="comment">// x轴位移到x起点，y终点，也就是下方</span></span><br><span class="line">        .call(xAxis)</span><br><span class="line">      axesG.append(<span class="string">'g'</span>).attr(<span class="string">'class'</span>, <span class="string">'yAxis'</span>)</span><br><span class="line">        .attr(<span class="string">'transform'</span>, () =&gt; <span class="string">`translate(<span class="subst">$&#123;xStart&#125;</span>,<span class="subst">$&#123;yStart&#125;</span>)`</span>) <span class="comment">// y轴位移到x起点，y起点</span></span><br><span class="line">        .call(yAxis)</span><br><span class="line">      <span class="keyword">return</span> _chart</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://static.yuanziwen.cn/blog/d3Line/2.jpg_plain" alt="alt"></p>
<p>ojbk，咱们继续</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">init()&#123;</span><br><span class="line">  <span class="keyword">this</span>.stackedAreaChart = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ... 接上文</span></span><br><span class="line">    _chart.renderBody = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!_bodyG) &#123; <span class="comment">// 同样，防止再次绘制</span></span><br><span class="line">        _bodyG = _svg.append(<span class="string">'g'</span>)</span><br><span class="line">          .attr(<span class="string">'class'</span>, <span class="string">'body'</span>)</span><br><span class="line">          .attr(<span class="string">'transform'</span>, <span class="string">`translate(<span class="subst">$&#123;xStart&#125;</span>,<span class="subst">$&#123;yStart&#125;</span>)`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> _chart</span><br><span class="line">    &#125;</span><br><span class="line">    _chart.renderLines = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 创建折线</span></span><br><span class="line">      <span class="keyword">const</span> _line = d3</span><br><span class="line">        .line() <span class="comment">// 折线路径生成器，通过传入dataList的date和value，返回相应坐标点</span></span><br><span class="line">        .curve(d3.curveCardinal.tension(<span class="number">0.8</span>)) <span class="comment">// 这里我们让它的折线有点弯曲度，0为完全弯曲 1为不弯曲</span></span><br><span class="line">        .x(<span class="function"><span class="params">d</span> =&gt;</span> xScale(d.date))</span><br><span class="line">        .y(<span class="function"><span class="params">d</span> =&gt;</span> yScale(d.value))</span><br><span class="line"></span><br><span class="line">      _bodyG.selectAll(<span class="string">'path.line'</span>) <span class="comment">// 选中所有折线，类似jq选择器,line是即将添加的class，上下必须一致</span></span><br><span class="line">        .data(_data) <span class="comment">// 绑定数组数据</span></span><br><span class="line">        .enter().append(<span class="string">'path'</span>) <span class="comment">// 补集添加</span></span><br><span class="line">        .classed(<span class="string">'line'</span>, <span class="literal">true</span>) <span class="comment">// 设置class  必须上下一致</span></span><br><span class="line">        .style(<span class="string">'stroke'</span>, (d, i) =&gt; color[i]) <span class="comment">// 通过下标取颜色，由于我们用的是path，不能去使用fill内填充</span></span><br><span class="line">        <span class="comment">// .transition()</span></span><br><span class="line">        <span class="comment">// .duration(500)</span></span><br><span class="line">        .attr(<span class="string">'d'</span>, item =&gt; _line(item.dataList)) <span class="comment">// d为路径，通过item.dateList生成一条折线</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _chart.data = <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123; <span class="comment">// 获取数据/设置</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">arguments</span>.length) <span class="keyword">return</span> _data</span><br><span class="line">      _data = data</span><br><span class="line">      <span class="keyword">return</span> _chart</span><br><span class="line">    &#125;</span><br><span class="line">    _this.xScale = xScale</span><br><span class="line">    _this.yScale = yScale</span><br><span class="line">    _this.xAxis = xAxis</span><br><span class="line">    _this.yAxis = yAxis</span><br><span class="line">    <span class="keyword">return</span> _chart</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.render() <span class="comment">// 调用render绘制主体</span></span><br><span class="line">&#125;,</span><br><span class="line">render()&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方法都定义完了，我们接下来准备调用进行绘制,很简单</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">render()&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; chart, data, stackedAreaChart, max &#125; = <span class="keyword">this</span></span><br><span class="line">  <span class="keyword">const</span> list = [...data] <span class="comment">// 拷贝一份</span></span><br><span class="line">  <span class="keyword">this</span>.chart = stackedAreaChart()</span><br><span class="line">  <span class="keyword">this</span>.chart.data(list).render().renderAxes().renderBody().renderLines()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://static.yuanziwen.cn/blog/d3Line/3.jpg_plain" alt="alt"><br>画是画出来了，总感觉哪里有些不对？因为x轴刻度与刻度之间本身是没有间距的，每个刻度所占的宽度可以用<code>xScale.bandwidth()</code>来获取，我们在<code>renderLines</code>里添加一段代码做验证</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">_bodyG.selectAll(<span class="string">'rect'</span>)</span><br><span class="line"> .data(_data[<span class="number">0</span>].dataList)<span class="comment">// 绑定数据</span></span><br><span class="line"> .enter() <span class="comment">// 选定补集</span></span><br><span class="line"> .append(<span class="string">'rect'</span>) <span class="comment">// 将补集添加为rect</span></span><br><span class="line"> .attr(<span class="string">'x'</span>, d =&gt; xScale(d.date)) <span class="comment">// 计算x轴水平位置</span></span><br><span class="line"> .attr(<span class="string">'y'</span>, <span class="number">0</span>) <span class="comment">// 垂直位置</span></span><br><span class="line"> .attr(<span class="string">'height'</span>, yScale(<span class="number">0</span>))</span><br><span class="line"> .attr(<span class="string">'width'</span>, xScale.bandwidth())</span><br><span class="line"> .attr(<span class="string">'fill'</span>, <span class="string">'none'</span>) <span class="comment">// 无内填充</span></span><br><span class="line"> .attr(<span class="string">'stroke'</span>, <span class="string">'steelblue'</span>); <span class="comment">// 描边颜色</span></span><br></pre></td></tr></table></figure>

<p><img src="https://static.yuanziwen.cn/blog/d3Line/4.jpg_plain" alt="alt"><br>可以看到每个’拐角点’都在每个刻度的起点位置，所以我们需要把<code>bodyG</code>往右边位移<code>xScale.bandwidth()/2</code><br>找到bodyG</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"> _chart.renderBody = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!_bodyG) &#123;</span><br><span class="line">    _bodyG = _svg.append(<span class="string">'g'</span>)</span><br><span class="line">      .attr(<span class="string">'class'</span>, <span class="string">'body'</span>)</span><br><span class="line">      .attr(<span class="string">'transform'</span>, <span class="string">`translate(<span class="subst">$&#123;xStart+xScale.bandwidth()<span class="regexp">/2&#125;,$&#123;yStart&#125;)`)</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">  &#125;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">  return _chart</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">&#125;</span></span></span></span><br></pre></td></tr></table></figure>

<p><img src="https://static.yuanziwen.cn/blog/d3Line/5.jpg_plain" alt="alt"></p>
<p>这样就正常了，但是我们想让左右贴边，空着一块感觉少点什么，比例尺有个调整间距<code>padding(p:number)</code>方法，我们给它传0.5代表每个刻度之间间距0.5</p>
<p><img src="https://static.yuanziwen.cn/blog/d3Line/6.jpg_plain" alt="alt"></p>
<p>是的，你肯定猜到了些什么，如果传负数<code>xScale = d3.scaleBand().range([0, chartWidth]).domain(xLineList).padding(-1)</code></p>
<p><img src="https://static.yuanziwen.cn/blog/d3Line/8.jpg_plain" alt="alt"></p>
<p>完美，Echarts<a href="https://echarts.baidu.com/examples/editor.html?c=line-stack" target="_blank" rel="noopener">示例</a>人家有动画，我们也能做，接下来我们将添加入场动画事件。利用到<code>SVGelement.transition().duration(time:Number|过渡时间)</code>与stroke的<code>dasharray</code>和<code>dashoffset</code>的CSS属性</p>
<blockquote>
<p>stroke-dasharray 在SVG中表示描边是虚线，接收两个值，第一个是虚线的宽度，第二个是虚线之间的间距，<a href="https://www.zhangxinxu.com/wordpress/2014/04/animateion-line-drawing-svg-path-%e5%8a%a8%e7%94%bb-%e8%b7%af%e5%be%84/" target="_blank" rel="noopener">更多方法请查略张鑫旭示例</a></p>
</blockquote>
<blockquote>
<p>stroke-dashoffset 指定每个实线线段的起始偏移量。正数从路径起始点向前偏移，负数则向后。<a href="https://www.zhangxinxu.com/wordpress/2017/12/canvas-getimagedata-letter-shape-animation/" target="_blank" rel="noopener">更多方法请查略张鑫旭示例</a></p>
</blockquote>
<p>可以用<code>d3.select(this).node().getTotalLength()</code>选中当前的path获取其长度,再设置<code>stroke-dasharray(length,length)</code>使其从 |———| 达到 |———|  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |—👁—|，👁为可视区,再通过<code>stroke-dashoffset(length)</code>使其变成 |———| 👁 |———| ，设置完动画前的状态之后，添加动画，动态将stroke-dashoffset的值归0，达到了border transition的伪效果</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">_bodyG.selectAll(<span class="string">'path.line'</span>) <span class="comment">// 选中所有折线，类似jq选择器,line是即将添加的class，上下必须一致</span></span><br><span class="line">  .data(_data) <span class="comment">// 绑定数组数据</span></span><br><span class="line">  .enter().append(<span class="string">'path'</span>) <span class="comment">// 补集添加</span></span><br><span class="line">  .classed(<span class="string">'line'</span>, <span class="literal">true</span>) <span class="comment">// 设置class  必须上下一致</span></span><br><span class="line">  .style(<span class="string">'stroke'</span>, (d, i) =&gt; color[i]) <span class="comment">// 通过下标取颜色，由于我们用的是path，不能去使用fill内填充</span></span><br><span class="line">  .attr(<span class="string">'d'</span>, item =&gt; _line(item.dataList)) <span class="comment">// d为路径，通过item.dateList生成一条折线</span></span><br><span class="line">  .attr(<span class="string">'stroke-dasharray'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">d, i</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> length = d3.select(<span class="keyword">this</span>).node().getTotalLength()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;length&#125;</span> <span class="subst">$&#123;length&#125;</span>`</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .attr(<span class="string">'stroke-dashoffset'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">d, i</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> d3.select(<span class="keyword">this</span>).node().getTotalLength()</span><br><span class="line">  &#125;)</span><br><span class="line">  .transition()</span><br><span class="line">  .duration(<span class="number">5000</span>)</span><br><span class="line">  .ease(d3.easeLinear)</span><br><span class="line">  .attr(<span class="string">'stroke-dashoffset'</span>, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://static.yuanziwen.cn/blog/d3Line/9.gif_plain%5C" alt="alt"></p>
<p>剩下的就是在上面加上鼠标交互了。</p>
<p>思路是在svg上监听鼠标移动，获取其位置，算出介于X轴的某段范围，拿到其数据，渲染tips。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; copyData, svg, yScale, xStart, yStart, chartWidth, xScale, chartHeight &#125; = <span class="keyword">this</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 过滤用户隐藏的item</span></span><br><span class="line"><span class="keyword">const</span> filterList = copyData.filter(<span class="function"><span class="params">item</span> =&gt;</span> item.show)</span><br><span class="line"></span><br><span class="line"><span class="comment">// copyData 用于toggle各电商的显示情况,避免操作data数据</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> tip = <span class="keyword">this</span>.svg</span><br><span class="line">                  .append(<span class="string">'g'</span>)</span><br><span class="line">                  .attr(<span class="string">'class'</span>, <span class="string">'tip'</span>)</span><br><span class="line">                  .attr(<span class="string">'fill'</span>, <span class="string">'rgba(0,0,0,.7)'</span>)</span><br><span class="line"><span class="comment">// </span></span><br><span class="line">tip</span><br><span class="line">  .append(<span class="string">'rect'</span>)</span><br><span class="line">  .attr(<span class="string">'class'</span>, <span class="string">'tip-border'</span>)</span><br><span class="line">  .attr(<span class="string">'width'</span>, <span class="number">120</span>)</span><br><span class="line">  .attr(<span class="string">'height'</span>, <span class="number">50</span>)</span><br><span class="line">  .attr(<span class="string">'rx'</span>, <span class="number">8</span>)</span><br><span class="line">  .attr(<span class="string">'ry'</span>, <span class="number">8</span>)</span><br><span class="line">  .attr(<span class="string">'opacity'</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 标题</span></span><br><span class="line">tip</span><br><span class="line">  .append(<span class="string">'text'</span>)</span><br><span class="line">  .classed(<span class="string">'tip-title'</span>,<span class="literal">true</span>)</span><br><span class="line">  .attr(<span class="string">'x'</span>,<span class="number">10</span>)</span><br><span class="line">  .attr(<span class="string">'y'</span>,<span class="number">15</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://static.yuanziwen.cn/blog/d3Line/10.png_plain" alt="alt"></p>
<p>为什么要用<code>g</code>套一层？ 因为不止有一个<code>rect</code>，还有<code>text</code>和<code>circle</code>。而且g本身并不支持圆角，只能用 <code>rect</code>。</p>
<p>还有鼠标移入的x轴标尺线。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> tipLine = <span class="keyword">this</span>.svg.append(<span class="string">'line'</span>).calssed(<span class="string">'tip-line'</span>,<span class="literal">true</span>)</span><br><span class="line"><span class="keyword">let</span> nowIndex <span class="comment">// 当前区间的下标</span></span><br><span class="line"><span class="keyword">const</span> bw = xScale.step() / <span class="number">2</span>; <span class="comment">//x轴区间的范围。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 仿Echarts圆点</span></span><br><span class="line"><span class="keyword">const</span> circles = <span class="keyword">this</span>.chart.append(<span class="string">'g'</span>).classed(<span class="string">'circleOfPath'</span>, <span class="literal">true</span>)</span><br><span class="line"><span class="keyword">const</span> allCircle = circles.selectAll(<span class="string">'circle'</span>).data(copyData).enter().append(<span class="string">'circle'</span>)</span><br></pre></td></tr></table></figure>

<p>需要拿到当前x轴区间坐标map的集合，</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">computed:&#123;</span><br><span class="line">  <span class="comment">// ...other,</span></span><br><span class="line">  mapx:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; xLineList, xScale, xStart, yStart, chartHeight&#125; = <span class="keyword">this</span></span><br><span class="line">      <span class="keyword">return</span> xLineList.map(<span class="function">(<span class="params">d, i</span>) =&gt;</span> (&#123;</span><br><span class="line">        x: xScale(d) + xStart + xScale.bandwidth() / <span class="number">2</span>,</span><br><span class="line">        y: (yStart + chartHeight) / <span class="number">2</span>,</span><br><span class="line">        index: i,</span><br><span class="line">        d</span><br><span class="line">      &#125;))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就能拿到x轴每个区间的xy轴位置及下标数据了， 使用 <code>on</code> 设置svg的 <code>mouseenter/mousemove/mouseleave</code>事件，然后获取当前鼠标的坐标</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">this</span>.svg.on(<span class="string">'mouseenter'</span>, () =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除掉所有的文本，这里可能每个公司业务不一样，我司的数据是不完整的，所以无法复用。</span></span><br><span class="line">    tip.selectAll(<span class="string">'.tip-item'</span>).remove()</span><br><span class="line"></span><br><span class="line">    tipLine.attr(<span class="string">'opacity'</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加标题</span></span><br><span class="line">    tip</span><br><span class="line">      .append(<span class="string">'text'</span>)</span><br><span class="line">      .attr(<span class="string">'class'</span>, <span class="string">'tip-title'</span>)</span><br><span class="line">      .attr(<span class="string">'x'</span>, <span class="number">10</span>)</span><br><span class="line">      .attr(<span class="string">'y'</span>, <span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过遍历当前命中的target区间数据，设置展示各电商当前区间的情况</span></span><br><span class="line">    tip.selectAll(<span class="string">'.tip-item'</span>).data(filterList).enter()</span><br><span class="line">      .append(<span class="string">'text'</span>)</span><br><span class="line">      .attr(<span class="string">'class'</span>, <span class="string">'tip-text content'</span>)</span><br><span class="line">      .attr(<span class="string">'x'</span>, <span class="number">15</span>)</span><br><span class="line">      .attr(<span class="string">'y'</span>, (d, i) =&gt; <span class="number">35</span> + i * <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前电商代表的颜色</span></span><br><span class="line">    tip.selectAll(<span class="string">'.tip-circle-item'</span>).data(filterList).enter()</span><br><span class="line">      .append(<span class="string">'circle'</span>)</span><br><span class="line">      .attr(<span class="string">'class'</span>, <span class="string">'tip-circle-item'</span>)</span><br><span class="line">      .attr(<span class="string">'cx'</span>, <span class="number">8</span>)</span><br><span class="line">      .attr(<span class="string">'cy'</span>, (d, i) =&gt; <span class="number">30</span> + i * <span class="number">20</span>)</span><br><span class="line">      .attr(<span class="string">'r'</span>, <span class="number">3</span>)</span><br><span class="line">      .attr(<span class="string">'opacity'</span>, <span class="number">0</span>)</span><br><span class="line">      .attr(<span class="string">'fill'</span>, (d, i) =&gt; d.color)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<p>现在看下效果<br><img src="https://static.yuanziwen.cn/blog/d3Line/11.png_plain" alt="alt"></p>
<p>高度和内容都没有? </p>
<p>不用着急,鼠标还没动起来.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">this</span>.svg.on(<span class="string">'mousemove'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> x = d3.event.offsetX</span><br><span class="line">  <span class="keyword">const</span> y = d3.event.offsetY</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 尝试找到当前鼠标处于某个区间范围内的数据</span></span><br><span class="line">  <span class="keyword">const</span> target = mapx.find(<span class="function"><span class="params">item</span> =&gt;</span> <span class="built_in">Math</span>.abs(x - item.x) &lt; bw)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果未匹配到 或者 当前区间等于上次鼠标移动时区间的数据，就不做处理了。</span></span><br><span class="line">  <span class="keyword">if</span> (!target || (nowIndex === target.index)) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  nowIndex = target.index</span><br><span class="line">  target.y = y <span class="comment">// 设置成当前鼠标所在的y坐标</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新标尺线位置，这里加上了动画</span></span><br><span class="line">  tipLine</span><br><span class="line">    .attr(<span class="string">'y1'</span>, chartHeight)</span><br><span class="line">    .attr(<span class="string">'y2'</span>, <span class="number">5</span>)</span><br><span class="line">    .attr(<span class="string">'x1'</span>, <span class="number">0</span>)</span><br><span class="line">    .attr(<span class="string">'x2'</span>, <span class="number">0</span>)</span><br><span class="line">    .interrupt()</span><br><span class="line">    .transition()</span><br><span class="line">    .duration(<span class="number">100</span>)</span><br><span class="line">    .ease(d3.easeBackOut)</span><br><span class="line">    .attr(</span><br><span class="line">      <span class="string">'transform'</span>,</span><br><span class="line">      <span class="string">`translate(<span class="subst">$&#123;target.x&#125;</span>,<span class="subst">$&#123;yStart&#125;</span>)`</span></span><br><span class="line">    )</span><br><span class="line">    .attr(<span class="string">'stroke'</span>, <span class="string">'rgba(0,0,0,0.65)'</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// title</span></span><br><span class="line">  tip.select(<span class="string">'.tip-title'</span>).text(target.d)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 各电商数据</span></span><br><span class="line">  tip.selectAll(<span class="string">'.tip-content'</span>).text(<span class="function">(<span class="params">d, i</span>) =&gt;</span> <span class="string">`<span class="subst">$&#123;d.name&#125;</span>:<span class="subst">$&#123;d.dataList[target.index].value&#125;</span>`</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://static.yuanziwen.cn/blog/d3Line/12.gif_plain%5C" alt="alt"></p>
<p>接下来还要动态设置<code>tip-border</code>的宽度和高度及它的位置</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"> allCircle</span><br><span class="line">    .attr(<span class="string">'cx'</span>, (d, i) =&gt; target.x - xStart)</span><br><span class="line">    <span class="comment">// 拿到当天的数值,通过yScale比例尺计算出y坐标</span></span><br><span class="line">    .attr(<span class="string">'cy'</span>, (d, i) =&gt; yScale(d.dataList[target.index].value))</span><br><span class="line">    .attr(<span class="string">'r'</span>, <span class="number">1</span>)</span><br><span class="line">    .attr(<span class="string">'fill'</span>, (d, i) =&gt; d.color)</span><br><span class="line">    .interrupt() <span class="comment">// 停止之前的动画</span></span><br><span class="line">    .transition()</span><br><span class="line">    .duration(<span class="number">200</span>)</span><br><span class="line">    .attr(<span class="string">'r'</span>, <span class="number">0</span>)</span><br><span class="line">    .transition()</span><br><span class="line">    .duration(<span class="number">500</span>)</span><br><span class="line">    .ease(d3.easeBackOut)</span><br><span class="line">    .attr(<span class="string">'r'</span>, <span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取最后一个circle的位置,动态设置tip-border的高度</span></span><br><span class="line">  <span class="keyword">let</span> lastCy = <span class="number">0</span></span><br><span class="line">  tip.selectAll(<span class="string">'.tip-circle-item'</span>)</span><br><span class="line">    .each(<span class="function"><span class="keyword">function</span> (<span class="params">d, i</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (i === filterList.length - <span class="number">1</span>) &#123;</span><br><span class="line">        lastCy = (d3.select(<span class="keyword">this</span>).attr(<span class="string">'cy'</span>)|<span class="number">0</span>) + <span class="number">20</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">  tip</span><br><span class="line">    .select(<span class="string">'.tip-border'</span>)</span><br><span class="line">    .transition()</span><br><span class="line">    .duration(<span class="number">100</span>)</span><br><span class="line">    .attr(<span class="string">'height'</span>, lastCy)</span><br><span class="line">    .attr(<span class="string">'opacity'</span>, <span class="number">0.6</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 动态获取item的宽度,得出的最大宽度即设置tip-border宽度</span></span><br><span class="line">  <span class="keyword">const</span> allTextWidth = []</span><br><span class="line">  svg.selectAll(<span class="string">'.tip-content'</span>).each(<span class="function"><span class="keyword">function</span> (<span class="params">d, i</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> allTextWidth.push(<span class="keyword">this</span>.getBoundingClientRect().width)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">const</span> tipWidth = d3.max(allTextWidth) + <span class="number">30</span></span><br><span class="line">  tip.select(<span class="string">'.tip-border'</span>).attr(<span class="string">'width'</span>, tipWidth)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取提示框应该出现的位置</span></span><br><span class="line">  <span class="keyword">const</span> mouseX = target.x</span><br><span class="line">  <span class="keyword">const</span> mouseY = y</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 提示框移动缓冲</span></span><br><span class="line">  tip</span><br><span class="line">    .interrupt()</span><br><span class="line">    .transition()</span><br><span class="line">    .duration(<span class="number">700</span>)</span><br><span class="line">    .ease(d3.easeBackOut)</span><br><span class="line">    .attr(<span class="string">'transform'</span>, <span class="string">`translate(<span class="subst">$&#123;mouseX&#125;</span>,<span class="subst">$&#123;mouseY&#125;</span>)`</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 提示框红点标记</span></span><br><span class="line">  tip.selectAll(<span class="string">'.tip-circle-item'</span>)</span><br><span class="line">    .interrupt()</span><br><span class="line">    .transition()</span><br><span class="line">    .duration(<span class="number">300</span>)</span><br><span class="line">    .attr(<span class="string">'opacity'</span>, <span class="number">0.9</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.tip-title</span>,<span class="selector-class">.tip-content</span>&#123;</span><br><span class="line">  <span class="attribute">fill</span>:<span class="number">#fff</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://static.yuanziwen.cn/blog/d3Line/13.gif_plain%5C" alt="alt"></p>
<p>看起来正常,但最后离开坐标轴的时候有一部分看不见了,这里需要动态判断下边界宽度.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取提示框应该出现的位置</span></span><br><span class="line">  <span class="keyword">const</span> mouseX = target.x</span><br><span class="line">  <span class="keyword">const</span> mouseY = y</span><br><span class="line">  <span class="comment">// 如果剩下的位置不够显示提示框就换个方向</span></span><br><span class="line">  <span class="keyword">const</span> tipX = mouseX + (((mouseX + tipWidth) &gt; chartWidth) ? -tipWidth - <span class="number">10</span> : <span class="number">10</span>)</span><br><span class="line">  <span class="comment">// 垂直方向也同样</span></span><br><span class="line">  <span class="keyword">const</span> tipY = mouseY + (((mouseY + lastCy / <span class="number">2</span>) &gt; chartHeight) ? -lastCy : <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 提示框移动缓冲</span></span><br><span class="line">  tip</span><br><span class="line">    .interrupt()</span><br><span class="line">    .transition()</span><br><span class="line">    .duration(<span class="number">700</span>)</span><br><span class="line">    .ease(d3.easeBackOut)</span><br><span class="line">    .attr(<span class="string">'transform'</span>, <span class="string">`translate(<span class="subst">$&#123;tipX&#125;</span>,<span class="subst">$&#123;tipY&#125;</span>)`</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://static.yuanziwen.cn/blog/d3Line/14.gif_plain%5C" alt="alt"></p>
<p>最后的leave事件.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">.on(<span class="string">'mouseleave'</span>, () =&gt; &#123;</span><br><span class="line">  nowIndex = <span class="literal">null</span></span><br><span class="line">  tip.selectAll(<span class="string">'.tip-text'</span>).remove()</span><br><span class="line">  tip.select(<span class="string">'.tip-border'</span>).remove()</span><br><span class="line">  tip.selectAll(<span class="string">'.tip-circle-item'</span>).remove()</span><br><span class="line">  tipLine.remove()</span><br><span class="line">  allCircle.interrupt().attr(<span class="string">'r'</span>, <span class="number">0</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<!-- 剩下还有toggle切换各渠道电商的显示情况了. -->
</details>
        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2019/01/17/typescript——基础篇/">typescript——基础篇</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-01-17
        </span></div>
    </header>

    <div class="post-content"><p><img src="https://static.yuanziwen.cn/blob/typescript/1.jpg_plain" alt="alt"></p>
          <div class="read-more">
            <a href="/2019/01/17/typescript——基础篇/" class="read-more-link">Read more..</a>
          </div>
        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/12/19/设计模式/">JavaScript设计模式</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-12-19
        </span></div>
    </header>

    <div class="post-content"><h2 id="设计模式是什么妖"><a href="#设计模式是什么妖" class="headerlink" title="设计模式是什么妖"></a>设计模式是什么妖</h2><p><img src="'https://static.yuanziwen.cn/blog/design/book.png'" alt="alt"></p>
          <div class="read-more">
            <a href="/2018/12/19/设计模式/" class="read-more-link">Read more..</a>
          </div>
        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/08/02/Vue源码剖析——render、patch、updata、vnode/">Vue源码剖析——render、patch、updata、vnode</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-08-02
        </span></div>
    </header>

    <div class="post-content"><h2 id="flow前置"><a href="#flow前置" class="headerlink" title="flow前置"></a>flow前置</h2><p><img src="https://static.yuanziwen.cn/blog/Vue/poster.png_plain" alt><br>在<code>Vue</code>源码里，尤大采用了<code>Flow</code>作为静态类型检查，<code>Flow</code>是<code>facebook</code>出品的静态类型检查工具。</p>
          <div class="read-more">
            <a href="/2018/08/02/Vue源码剖析——render、patch、updata、vnode/" class="read-more-link">Read more..</a>
          </div>
        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/07/24/一次性搞懂JvaScript执行机制/">一次性搞懂JvaScript执行机制</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-07-24
        </span></div>
    </header>

    <div class="post-content"><p><img src="https://user-gold-cdn.xitu.io/2018/7/21/164b8954d3b097d4?imageView2/1/w/1304/h/734/q/85/format/webp/interlace/1" alt></p>
          <div class="read-more">
            <a href="/2018/07/24/一次性搞懂JvaScript执行机制/" class="read-more-link">Read more..</a>
          </div>
        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/07/01/vue源码——snabbdom虚拟DOM/">vue源码——snabbdom虚拟DOM（转载）</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-07-01
        </span></div>
    </header>

    <div class="post-content"><p><a href="https://github.com/zyl1314/blog/issues/11" target="_blank" rel="noopener">原文</a></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><a href="https://github.com/snabbdom/snabbdom" target="_blank" rel="noopener">snabbdom</a>是一个虚拟dom算法库，它的特点是效率高、可扩展，许多开源项目采用了这种算法，例如vue。本文试图还原虚拟dom的diff原理（仅限于snabbdom算法）。</p>
          <div class="read-more">
            <a href="/2018/07/01/vue源码——snabbdom虚拟DOM/" class="read-more-link">Read more..</a>
          </div>
        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/06/17/一次性让你动async-await，解决回调地狱/">一次性让你懂async/await，解决回调地狱</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-06-17
        </span></div>
    </header>

    <div class="post-content"><h2 id="什么是async？"><a href="#什么是async？" class="headerlink" title="什么是async？"></a>什么是async？</h2><p><img src="https://static.yuanziwen.cn/blog/image/asynctitle.png_plain" alt="alt"></p>
<blockquote><p><code class="codes">async</code> 函数是 <code class="codes">Generator</code> 函数的语法糖。使用 关键字 <code class="codes">async</code> 来表示，在函数内部使用 <code class="codes">await</code> 来表示异步。相较于 <code class="codes">Generator</code>，<code class="codes">async</code> 函数的改进在于下面四点：</p>
</blockquote>
          <div class="read-more">
            <a href="/2018/06/17/一次性让你动async-await，解决回调地狱/" class="read-more-link">Read more..</a>
          </div>
        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/06/09/论浏览器本地存储Cookie、Session-Local、indexDB、ServiceWork优劣及趋向/">本地存储Cookie、Session/Local、indexDB、ServiceWork</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-06-09
        </span></div>
    </header>

    <div class="post-content"><p><img src="https://static.yuanziwen.cn/title.png_plain" alt="alt"><br>在日常开发中，开发者用得最多的大概是前三种吧，cookie、Session/Local，对后两种运用的较少，话不多少，直接正文：</p>
          <div class="read-more">
            <a href="/2018/06/09/论浏览器本地存储Cookie、Session-Local、indexDB、ServiceWork优劣及趋向/" class="read-more-link">Read more..</a>
          </div>
        </div></article>
      <nav class="pagination"><a class="prev" href="/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text">Prev</span>
      </a>
    <a class="next" href="/page/3/">
        <span class="next-text">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></section></div></div>
      </main><footer id="footer" class="footer"><div class="social-links"><a href="mailto:yuanziwen7489757@gmail.com" class="iconfont icon-email" title="email"></a>
          <a href="https://juejin.im/user/59aa31a06fb9a02485103ddf" class="iconfont juejin" title="掘金"><div class="img"></div></a>
        <a href="https://github.com/yzw7489757" class="iconfont icon-github" title="github"></a>
        </div><div class="copyright">
  <!--<span class="division">|</span>
  <span class="theme-info">
    footer.theme - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>-->
  <span class="power-by">
   <a href="http://www.beian.miit.gov.cn" target="_blank">浙ICP备18011257号-1</a>
  </span>
  <span class="copyright-year">&copy;2017 - 2020<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Seven</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
<script>if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js?t=1593502174043')
    .then(function () {console.log('ServiceWorker Register Successfully.')})
    .catch(function (e) {console.error(e)});
}
</script></body>
</html>
